---
description: Backend API development guidelines for Hono, Drizzle ORM, and Better Auth
globs: apps/api/**/*
alwaysApply: false
---
# Backend API Guidelines

The Kaneo API is built with Hono, Drizzle ORM, PostgreSQL, and Better Auth. This document outlines conventions and patterns for backend development.

## Framework: Hono

Hono is a lightweight web framework. Follow these patterns:

### Route Structure

Routes are organized by feature in `apps/api/src/`:

```typescript
// apps/api/src/task/index.ts
import { Hono } from "hono";
import { describeRoute, resolver, validator } from "hono-openapi";
import * as v from "valibot";
import createTask from "./controllers/create-task";
import getTask from "./controllers/get-task";

const task = new Hono<{
  Variables: {
    userId: string;
  };
}>()
  .get(
    "/:id",
    describeRoute({
      operationId: "getTask",
      tags: ["Tasks"],
      description: "Get a specific task by ID",
      responses: {
        200: {
          description: "Task details",
          content: {
            "application/json": { schema: resolver(taskSchema) },
          },
        },
      },
    }),
    validator("param", v.object({ id: v.string() })),
    async (c) => {
      const { id } = c.req.valid("param");
      const task = await getTask(id);
      return c.json(task);
    },
  );

export default task;
```

### Best Practices

1. **Always use OpenAPI decorators**: Use `describeRoute` for all endpoints
2. **Validate inputs**: Use `validator` with Valibot schemas
3. **Extract controllers**: Keep route handlers thin, move logic to controller files
4. **Type safety**: Use Hono's type system for context variables

```typescript
// Good: Thin route handler
.get("/:id", validator("param", v.object({ id: v.string() })), async (c) => {
  const { id } = c.req.valid("param");
  const task = await getTask(id);
  return c.json(task);
})

// Bad: Business logic in route handler
.get("/:id", async (c) => {
  const id = c.req.param("id");
  const task = await db.select().from(taskTable).where(eq(taskTable.id, id));
  // ... more logic
  return c.json(task);
})
```

## Database: Drizzle ORM

### Schema Definition

Define schemas in `apps/api/src/database/schema.ts`:

```typescript
import { pgTable, text, timestamp, boolean } from "drizzle-orm/pg-core";
import { createId } from "@paralleldrive/cuid2";

export const taskTable = pgTable("task", {
  id: text("id")
    .$defaultFn(() => createId())
    .primaryKey(),
  title: text("title").notNull(),
  createdAt: timestamp("created_at", { mode: "date" }).defaultNow().notNull(),
  updatedAt: timestamp("updated_at", { mode: "date" })
    .defaultNow()
    .$onUpdate(() => new Date())
    .notNull(),
});
```

### Best Practices

1. **Use CUID2 for IDs**: Always use `createId()` from `@paralleldrive/cuid2`
2. **Timestamps**: Always include `createdAt` and `updatedAt` with proper defaults
3. **Foreign Keys**: Use cascade deletes/updates where appropriate
4. **Indexes**: Add indexes for frequently queried columns

```typescript
// Good: Proper schema with indexes
export const taskTable = pgTable(
  "task",
  {
    id: text("id").$defaultFn(() => createId()).primaryKey(),
    projectId: text("project_id")
      .notNull()
      .references(() => projectTable.id, {
        onDelete: "cascade",
        onUpdate: "cascade",
      }),
    // ...
  },
  (table) => [index("task_projectId_idx").on(table.projectId)],
);
```

### Migrations

1. **Generate migrations**: `pnpm --filter @kaneo/api db:generate`
2. **Run migrations**: Automatically on API startup (see `apps/api/src/index.ts`)
3. **Migration files**: Stored in `apps/api/drizzle/`

## Authentication: Better Auth

Better Auth handles authentication. Access user context via Hono variables:

```typescript
// User is available in context after auth middleware
const userId = c.get("userId");
const user = c.get("user");
const session = c.get("session");
```

### API Key Authentication

API keys are supported via Bearer token:

```typescript
// Middleware in apps/api/src/index.ts handles this
// Authorization: Bearer <api-key>
```

## Validation: Valibot

Use Valibot for request validation:

```typescript
import * as v from "valibot";

validator(
  "json",
  v.object({
    title: v.string(),
    description: v.optional(v.string()),
    dueDate: v.optional(v.string()),
  }),
)
```

## Controller Pattern

Controllers contain business logic and are imported into route files:

```typescript
// apps/api/src/task/controllers/get-task.ts
import db from "../../database";
import { taskTable } from "../../database/schema";
import { eq } from "drizzle-orm";

export default async function getTask(id: string) {
  const [task] = await db
    .select()
    .from(taskTable)
    .where(eq(taskTable.id, id));

  if (!task) {
    throw new HTTPException(404, { message: "Task not found" });
  }

  return task;
}
```

## Error Handling

Use Hono's HTTPException for errors:

```typescript
import { HTTPException } from "hono/http-exception";

if (!task) {
  throw new HTTPException(404, { message: "Task not found" });
}
```

## Events

Publish events for activity tracking:

```typescript
import { publishEvent } from "../events";

await publishEvent("task.status_changed", {
  taskId: task.id,
  userId: user,
  oldStatus: task.status,
  newStatus: status,
  title: task.title,
  type: "status_changed",
});
```

## File Organization

```
apps/api/src/
├── activity/          # Activity feature
│   ├── controllers/
│   └── index.ts
├── auth.ts            # Better Auth configuration
├── config/            # Configuration endpoints
├── database/          # Database schema and connection
│   ├── schema.ts
│   ├── relations.ts
│   └── index.ts
├── events/            # Event publishing
├── task/              # Task feature
│   ├── controllers/
│   └── index.ts
└── index.ts           # Main entry point
```

## CORS Configuration

CORS is configured in `apps/api/src/index.ts`. Set `CORS_ORIGINS` environment variable for production.
